<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FamilyCheck</title>


<style>
:root{
  --bg:#202424;
  --card:#262b2b;
  --border:#343a3a;
  --text:#e6e6e6;
  --muted:#b0b7b7;
  --accent:#5fb3a2;
  --blue:#64b5f6;
  --danger:#e57373;

}


*{box-sizing:border-box}

body{
  margin:0;
  padding:16px;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

h1{
  font-size:1.3rem;
  margin-bottom:16px;
  font-weight:600;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:8px;
  padding:16px;
  margin-bottom:16px;
}

label{
  display:block;
  margin-top:12px;
  font-size:0.85rem;
  color:var(--muted);
}

input,select{
  width:100%;
  margin-top:6px;
  padding:8px 10px;
  border-radius:4px;
  border:1px solid var(--border);
  background:#1a1a1a;
  color:var(--text);
}

input:focus,select:focus{
  outline:none;
  border-color:var(--accent);
}

.grid{
  display:grid;
  grid-template-columns: 1.2fr repeat(4, 44px);
  gap:6px;
  align-items:center;
  font-size:0.85rem;
}

.grid strong{
  font-weight:500;
  color:#fff;
}

.radio{
  text-align:center;
}

.presencia{
  grid-column:1/-1;
  margin-left:4px;
  margin-top:4px;
  font-size:0.75rem;
  color:var(--muted);
  display:none;
}

.result{
  border-radius:6px;
  padding:12px;
  font-weight:600;
  background:#1a1a1a;
  border:1px solid var(--border);
}

.fcA{color:#81c784}
.fcB{color:var(--blue)}
.fcC{color:#ffb74d}
.fcD{color:var(--danger)}

button{
  width:100%;
  margin-top:10px;
  padding:12px;
  border:none;
  border-radius:6px;
  background:var(--accent);
  color:#000;
  font-weight:600;
  cursor:pointer;
}

button.secondary{
  background:#2a2a2a;
  color:var(--text);
}

.list-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid var(--border);
  font-size:0.9rem;
}

.list-item small{
  color:var(--muted);
}

.trash{
  background:none;
  border:none;
  color:var(--danger);
  font-size:1.1rem;
  cursor:pointer;
}
</style>
</head>

<body>

<h1>âž• AÃ±adir ficha Â· FamilyCheck</h1>

<div class="card">
  <label>Tipo</label>
  <select id="tipo">
    <option value="pelicula">PelÃ­cula</option>
    <option value="libro">Libro</option>
  </select>

  <label>TÃ­tulo</label>
  <input id="titulo">

  <label>AÃ±o / ISBN</label>
  <input id="extra1">

  <label>Director / Autor</label>
  <input id="extra2">
</div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const categorias=["sexo","violencia","lenguaje","drogas","miedo"];
const supabaseUrl = 'https://sdjwodswgtxgqirgqlpa.supabase.co'
const supabaseKey = 'sb_publishable_ea51fJNYUVesmBpSMGzqHw_xhLty22L'
const sb = supabase.createClient(supabaseUrl, supabaseKey)

let estado={};
let comentariosPendientes = [];

function mostrar(cat){
  const nivel=+document.querySelector(`input[name=${cat}]:checked`).value;
  document.getElementById(`p_${cat}`).style.display = nivel>=2?"block":"none";
  actualizar();
}

function actualizar(){
  categorias.forEach(c=>{
    const n=+document.querySelector(`input[name=${c}]:checked`).value;
    if(n>=2){
      const p=document.querySelector(`input[name=pr_${c}]:checked`).value;
      estado[c]={nivel:n,pres:p};
    }else estado[c]={nivel:n};
  });
  calcularFC();
}

function calcularFC(){
  let fc=9;
  Object.values(estado).forEach(d=>{
    if(d.nivel===2) fc-=d.pres==="continuado"?1:0.5;
    if(d.nivel===3) fc-=d.pres==="continuado"?2:1;
  });
  fc=Math.max(1,Math.min(10,Math.round(fc)));
  let edad=fc>=8?7:fc>=6?12:16;
  let clase=fc>=9?"fcA":fc>=7?"fcB":fc>=4?"fcC":"fcD";
  document.getElementById("resultado").innerHTML =
  `Edad recomendada: ${edad}+<br>FamilyCheck: <span class="${clase}">${fc}/10</span>`;
}
function calcularFCvalor(){
  let fc=9;
  Object.values(estado).forEach(d=>{
    if(d.nivel===2) fc-=d.pres==="continuado"?1:0.5;
    if(d.nivel===3) fc-=d.pres==="continuado"?2:1;
  });
  return Math.max(1,Math.min(10,Math.round(fc)));
}

function calcularEdad(){
  const fc = calcularFCvalor();
  return fc>=8 ? 7 : fc>=6 ? 12 : 16;
}
  async function guardarComentario(){
  const categoria = document.getElementById("categoriaComentario").value;
  const texto = document.getElementById("textoComentario").value.trim();

  if(!texto){
    alert("El comentario estÃ¡ vacÃ­o");
    return;
  }

  // Si la ficha aÃºn NO estÃ¡ guardada â†’ lo guardamos en memoria
  if(!window.fichaActualId){
    comentariosPendientes.push({ categoria, texto });
    renderComentariosTemporales();
  } else {
    // Si ya hay ficha â†’ se guarda directamente en BD
    const { error } = await sb
      .from("comentarios")
      .insert([{ ficha_id: window.fichaActualId, categoria, texto }]);

    if(error){
      alert(error.message);
      return;
    }

    cargarComentarios();
  }

  document.getElementById("textoComentario").value = "";
}


async function cargarComentarios(){
  if(!window.fichaActualId) return;

  const { data, error } = await sb
    .from("comentarios")
    .select("*")
    .eq("ficha_id", window.fichaActualId)
    .order("created_at", { ascending: true });

  if(error) return;

  document.getElementById("listaComentarios").innerHTML =
    data.map(c => `
      <div style="margin-top:6px;font-size:.85rem">
        <strong>${c.categoria}</strong>: ${c.texto}
      </div>
    `).join("");
}
function renderComentariosTemporales(){
  document.getElementById("listaComentarios").innerHTML =
    comentariosPendientes.map(c => `
      <div style="margin-top:6px;font-size:.85rem;opacity:.7">
        <strong>${c.categoria}</strong>: ${c.texto}
        <em style="font-size:.7rem"> (pendiente)</em>
      </div>
    `).join("");
}

async function guardar(){
  if(!titulo.value.trim()){
    alert("Falta el tÃ­tulo");
    return;
  }

  const tipoVal = tipo.value;

  const ficha = {
    tipo: tipoVal,
    titulo: titulo.value,
    fc_score: calcularFCvalor(),
    edad: calcularEdad(),
    anio: tipoVal !== "libro" ? parseInt(extra1.value) || null : null,
    director: tipoVal === "pelicula" ? extra2.value || null : null,
    autor: tipoVal === "libro" ? extra2.value || null : null,
    isbn: tipoVal === "libro" ? extra1.value || null : null
  };

  const { data, error } = await sb
    .from("fichas")
    .insert([ficha])
    .select()
    .single();

  if(error){
    alert(error.message);
    console.error(error);
    return;
  }

  window.fichaActualId = data.id;
  // Guardar comentarios pendientes
if(comentariosPendientes.length){
  await sb.from("comentarios").insert(
    comentariosPendientes.map(c => ({
      ficha_id: window.fichaActualId,
      categoria: c.categoria,
      texto: c.texto
    }))
  );
  comentariosPendientes = [];
}

  cargarComentarios();

  alert("Ficha guardada en Supabase âœ…");
}


function toggleListado(){
  listado.style.display=listado.style.display==="none"?"block":"none";
  renderListado();
}

function renderListado(){
  const data=JSON.parse(localStorage.getItem("fc")||"[]");
  resultadoListado.innerHTML=data.map(f=>`
<div class="list-item">
  <div>
    <strong>${f.titulo}</strong><br>
    <small>${f.extra1} Â· ${f.extra2}</small>
  </div>
  <button class="trash" onclick="borrar('${f.id}')">ðŸ—‘</button>
</div>`).join("");
}

function borrar(id){
  let data=JSON.parse(localStorage.getItem("fc")||"[]");
  data=data.filter(f=>f.id!==id);
  localStorage.setItem("fc",JSON.stringify(data));
  renderListado();
}
  
</script>

<div class="card">
  <div class="grid">
    <strong></strong>
    <strong>N</strong><strong>L</strong><strong>M</strong><strong>S</strong>

<script>
document.write(categorias.map(c=>`
<strong>${c.charAt(0).toUpperCase()+c.slice(1)}</strong>
${[0,1,2,3].map(v=>`
<div class="radio">
  <input type="radio" name="${c}" value="${v}"
    ${v===0?"checked":""}
    onchange="mostrar('${c}')">
</div>`).join("")}
<div class="presencia" id="p_${c}">
  Â¿Puntual o continuado?
  <label><input type="radio" name="pr_${c}" value="puntual" checked onchange="actualizar()"> Puntual</label>
  <label><input type="radio" name="pr_${c}" value="continuado" onchange="actualizar()"> Continuado</label>
</div>
`).join(""));
 
</script>
  </div>
</div>
<div class="card">
  <label>Comentario</label>

  <select id="categoriaComentario">
    <option value="sexo">Sexo</option>
    <option value="violencia">Violencia</option>
    <option value="lenguaje">Lenguaje</option>
    <option value="drogas">Drogas</option>
    <option value="miedo">Miedo</option>
  </select>

  <textarea id="textoComentario" rows="3"
    placeholder="AÃ±ade una observaciÃ³n concretaâ€¦"></textarea>

  <button onclick="guardarComentario()">AÃ±adir comentario</button>

  <div id="listaComentarios"></div>
</div>

<div class="result" id="resultado">
Edad recomendada: â€”<br>FamilyCheck: â€”
</div>
<script>
  actualizar();
</script>

<button onclick="guardar()">Guardar ficha</button>
<button class="secondary" onclick="toggleListado()">ðŸ“‹ Ver fichas</button>

<div class="card" id="listado" style="display:none;">
  <input id="buscador" placeholder="Buscar..." oninput="renderListado()">
  <div id="resultadoListado"></div>
</div>



</body>
</html>

